<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeGraph | System Design Document</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.9.0/mermaid.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=JetBrains+Mono:wght@400;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #1e293b; }
        code, pre { font-family: 'JetBrains Mono', monospace; }
        
        .section-header {
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
        }
        
        .diagram-box {
            background: #ffffff;
            border: 1px solid #cbd5e1;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin: 1.5rem 0;
            overflow-x: auto;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
        }

        .tech-card {
            background: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            margin-bottom: 2rem;
        }

        table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
        th { background-color: #f1f5f9; text-align: left; padding: 0.75rem; border-bottom: 2px solid #e2e8f0; font-weight: 600; color: #475569; }
        td { padding: 0.75rem; border-bottom: 1px solid #e2e8f0; color: #334155; vertical-align: top; }
        tr:last-child td { border-bottom: none; }
        
        .json-schema { background: #1e293b; color: #e2e8f0; padding: 1rem; border-radius: 0.5rem; font-size: 0.75rem; overflow-x: auto; }
    </style>
</head>
<body>

    <!-- Header -->
    <header class="bg-slate-900 text-white p-6 sticky top-0 z-50 shadow-md">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold tracking-tight">Enterprise CodeGraph</h1>
                <p class="text-slate-400 text-sm font-mono">Architecture & Implementation Specification</p>
            </div>
            <div class="flex items-center gap-4">
                <span class="px-3 py-1 bg-green-900 border border-green-700 rounded text-xs font-mono text-green-100">STATUS: APPROVED</span>
                <span class="px-3 py-1 bg-slate-800 border border-slate-700 rounded text-xs font-mono text-slate-300">DOC V 17.0</span>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-6">

        <!-- 1. Executive Summary -->
        <section id="executive-summary" class="tech-card border-l-4 border-l-blue-600">
            <div class="section-header">
                <h2 class="text-2xl font-bold text-slate-900">1. Executive Summary</h2>
            </div>
            <p class="text-lg leading-relaxed text-slate-700 mb-4">
                The Enterprise CodeGraph is a specialized intelligence layer designed to enable AI assistants to accurately navigate a complex, 100+ project N-Tier monorepo.
            </p>
            <p class="text-lg leading-relaxed text-slate-700">
                <strong>Version 17.0 Focus:</strong> This specification adopts an <strong>Orchestrator Architecture</strong>. Instead of maintaining complex custom parsers, the Python Indexer orchestrates industry-standard open-source tools: <strong>Syft</strong> (Structure), <strong>ast-grep</strong> (Forensics), <strong>SchemaCrawler</strong> (Database), and <strong>TruffleHog</strong> (Security). This maximizes reliability and minimizes maintenance code.
            </p>
            <div class="mt-4 flex gap-4 text-sm font-semibold text-slate-600">
                <span class="flex items-center"><i class="fas fa-check text-green-500 mr-2"></i> <strong>Standard CLI Toolchain</strong></span>
                <span class="flex items-center"><i class="fas fa-check text-green-500 mr-2"></i> <strong>Runtime Behavior Modeling</strong></span>
                <span class="flex items-center"><i class="fas fa-check text-green-500 mr-2"></i> <strong>Anti-Pattern Detection</strong></span>
            </div>
        </section>

        <!-- 2. System Architecture -->
        <section id="architecture" class="tech-card">
            <div class="section-header">
                <h2 class="text-2xl font-bold text-slate-900">2. System Architecture</h2>
            </div>
            <p class="mb-4 text-slate-600">The architecture is split into three distinct planes. The Indexing Plane now acts as an orchestrator for external binaries.</p>
            
            <div class="diagram-box">
                <div class="mermaid">
graph TD
    subgraph "Indexing Plane (Python Orchestrator)"
        Repo[Monorepo Root] -->|Exec: syft| P0(Phase 0: Skeleton)
        Repo -->|Exec: ast-grep| P1(Phase 1: Forensics)
        Repo -->|Exec: trufflehog| P15(Phase 1.5: Configs)
        TestDB[(Test Databases)] -->|Exec: schemacrawler| P2(Phase 2: Live DB Discovery)
        Git[.git History] -->|Exec: git log| P3(Phase 3: Temporal)
    end

    subgraph "Storage Plane (Docker)"
        P0 & P1 & P15 & P2 & P3 -->|Load JSON| PG[(PostgreSQL + pgvector)]
    end

    subgraph "Serving Plane (Custom MCP)"
        PG -->|Read/Query| MCP[CodeGraph MCP Server]
        MCP -->|11 Core Tools| AI[Amazon Q / Agent]
        Rules[.amazonq/rules] -.->|Directs| AI
    end

    classDef component fill:#e1effe,stroke:#1e429f,stroke-width:2px;
    classDef store fill:#f3f4f6,stroke:#374151,stroke-width:2px;
    
    class P0,P1,P15,P2,P3,MCP component;
    class PG,TestDB,Git,Repo,Rules store;
                </div>
            </div>
        </section>

        <!-- 3. Database Schema -->
        <section id="schema" class="tech-card">
            <div class="section-header">
                <h2 class="text-2xl font-bold text-slate-900">3. The Knowledge Graph (Schema)</h2>
            </div>
            <p class="mb-4 text-slate-600">Normalized PostgreSQL schema with <code>pgvector</code>. Expanded to support Monolith artifacts, Temporal data, and Sequence ordering. (See Appendix B for full SQL).</p>

            <div class="diagram-box">
                <div class="mermaid">
erDiagram
    PROJECTS ||--|{ JAVA_CLASSES : contains
    PROJECTS ||--|{ CONFIG_RESOURCES : contains

    JAVA_CLASSES ||--|{ JAVA_METHODS : defines
    JAVA_CLASSES {
        int id PK
        string name
        string package
        vector embedding
    }

    JAVA_METHODS ||--|{ CODE_DEPENDENCIES : originates
    JAVA_METHODS ||--|{ HTTP_ENDPOINTS : mapped_to
    JAVA_METHODS ||--|{ TRANSACTION_SCOPES : defines
    JAVA_METHODS ||--|{ SCHEDULED_JOBS : triggers
    JAVA_METHODS {
        int id PK
        string signature
        vector embedding
    }

    CODE_DEPENDENCIES {
        int source_method_id FK
        string target_class
        string target_member
        int line_number "For Sequence Order"
        string dependency_type "CALL/READ/WRITE/NEW"
    }

    HTTP_ENDPOINTS {
        string url_pattern
        string http_method
        boolean auth_required
        string endpoint_type "REST/SERVLET"
    }

    TRANSACTION_SCOPES {
        string annotation_type
        string propagation
        string isolation
    }

    CONFIG_RESOURCES {
        string filepath
        string resource_type "XML/PROPERTIES"
        jsonb parsed_content
    }

    JAVA_CLASSES ||--o| ORM_MAPPINGS : maps_to
    ORM_MAPPINGS ||--|| DB_TABLES : links_to
    
    DB_INSTANCES ||--|{ DB_TABLES : contains
    DB_TABLES ||--|{ DB_COLUMNS : contains

    JAVA_CLASSES ||--|{ GIT_METRICS : history
    GIT_METRICS {
        int class_id FK
        float churn_score
        string top_author
    }
    
    INDEXING_STATS {
        uuid run_id
        timestamp started_at
        string status
    }
                </div>
            </div>

            <h3 class="text-lg font-bold text-slate-800 mt-6 mb-3">3.1 Monolith & Ops Data Dictionary</h3>
            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead>
                        <tr>
                            <th class="w-1/4">Table</th>
                            <th class="w-1/4">Column</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="font-mono text-xs">code_dependencies</td>
                            <td class="font-mono text-xs">line_number</td>
                            <td>The source code line where the call occurs. Essential for reconstructing the chronological order of method calls within a function for sequence diagrams.</td>
                        </tr>
                        <tr>
                            <td class="font-mono text-xs">http_endpoints</td>
                            <td class="font-mono text-xs">url_pattern, auth_required</td>
                            <td>Maps REST Controllers and Servlets. <code>auth_required</code> flag is critical for identifying unprotected APIs.</td>
                        </tr>
                        <tr>
                            <td class="font-mono text-xs">transaction_scopes</td>
                            <td class="font-mono text-xs">propagation, isolation</td>
                            <td>Maps `@Transactional` boundaries. Vital for debugging deadlocks or consistency issues.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <h3 class="text-lg font-bold text-slate-800 mt-6 mb-3">3.2 AI-Optimized Views</h3>
            <div class="grid md:grid-cols-2 gap-4 mb-6">
                <div class="bg-blue-50 p-3 rounded border border-blue-100">
                    <h4 class="font-bold text-blue-900 text-sm">view_api_surface</h4>
                    <p class="text-xs text-blue-800">Joins Endpoints -> Methods -> Security Rules. Allows AI to answer "Show me all public POST endpoints".</p>
                </div>
                <div class="bg-emerald-50 p-3 rounded border border-emerald-100">
                    <h4 class="font-bold text-emerald-900 text-sm">view_db_access_points</h4>
                    <p class="text-xs text-emerald-800">Joins Methods -> ORM Mappings -> Tables -> DB Instances. Allows AI to answer "Which code modifies the 'users' table?".</p>
                </div>
            </div>

            <h3 class="text-lg font-bold text-slate-800 mt-6 mb-3">3.3 Anti-Pattern Views (Tech Debt)</h3>
            <p class="text-sm text-slate-600 mb-2">Pre-calculated views to instantly highlight architectural violations.</p>
            <div class="bg-red-50 border border-red-100 rounded p-4">
                <h4 class="font-mono font-bold text-sm text-red-900">view_layer_violations</h4>
                <p class="text-xs text-red-700 mb-2">Identifies 'Controller' classes that import 'DAO' or 'Repository' classes directly, skipping the Service layer.</p>
                <code class="block whitespace-pre-wrap text-xs font-mono text-red-900">
CREATE VIEW view_layer_violations AS
SELECT c.name as controller, t.name as direct_dao_dependency
FROM code_dependencies d
JOIN java_classes c ON d.source_method_id = c.id
JOIN java_classes t ON d.target_class = t.name
WHERE c.name LIKE '%Controller' AND (t.name LIKE '%DAO' OR t.name LIKE '%Repository');
                </code>
            </div>
        </section>

        <!-- 4. Indexer Mechanics -->
        <section id="indexer" class="tech-card">
            <div class="section-header">
                <h2 class="text-2xl font-bold text-slate-900">4. Indexing Pipeline (Orchestrator)</h2>
            </div>
            <p class="mb-4 text-slate-600">The pipeline runs sequentially to hydrate the graph. It uses <code>subprocess</code> to invoke standard tools and parses their JSON output.</p>

            <div class="grid gap-6">
                <!-- Phase 0 -->
                <div class="border-l-4 border-slate-500 bg-slate-50 p-4">
                    <h3 class="font-bold text-slate-900">Phase 0: Skeleton</h3>
                    <p class="text-sm text-slate-700 mt-1">
                        <strong>Tool:</strong> <code>syft</code>
                        <br><strong>Method:</strong> <code>syft scan dir:. -o json</code>
                        <br><strong>Outcome:</strong> Perfect artifact list and versions without custom POM parsing.
                    </p>
                </div>

                <!-- Phase 1 -->
                <div class="border-l-4 border-blue-500 bg-slate-50 p-4">
                    <h3 class="font-bold text-blue-900">Phase 1: Forensic Analysis</h3>
                    <p class="text-sm text-slate-700 mt-1">
                        <strong>Tool:</strong> <code>ast-grep</code>
                        <br><strong>Method:</strong> Custom patterns for `@RequestMapping`, `@Transactional`, Repositories, and Method Calls.
                        <br><strong>Outcome:</strong> Deep code understanding including line numbers for sequence diagrams.
                    </p>
                </div>

                <!-- Phase 1.5 -->
                <div class="border-l-4 border-purple-500 bg-slate-50 p-4">
                    <h3 class="font-bold text-purple-900">Phase 1.5: Resource Parsing</h3>
                    <p class="text-sm text-slate-700 mt-1">
                        <strong>Tools:</strong> <code>trufflehog</code> + <code>ast-grep</code>
                        <br><strong>Method:</strong>
                        1. Run `trufflehog` to find secrets. Skip infected files.
                        2. Use `ast-grep` to parse clean `web.xml` and properties.
                    </p>
                </div>

                <!-- Phase 2 -->
                <div class="border-l-4 border-emerald-500 bg-slate-50 p-4">
                    <h3 class="font-bold text-emerald-900">Phase 2: Live DB Discovery</h3>
                    <p class="text-sm text-slate-700 mt-1">
                        <strong>Tool:</strong> <code>schemacrawler</code>
                        <br><strong>Method:</strong> <code>schemacrawler --server=postgresql ... --command=serialize --output-format=json</code>
                        <br><strong>Outcome:</strong> Standardized JSON schema dump (Tables, FKs, Procs) regardless of underlying DB vendor.
                    </p>
                </div>

                <!-- Phase 3 -->
                <div class="border-l-4 border-amber-500 bg-slate-50 p-4">
                    <h3 class="font-bold text-amber-900">Phase 3: Temporal Context</h3>
                    <p class="text-sm text-slate-700 mt-1">
                        <strong>Tool:</strong> <code>git</code> (Native)
                        <br><strong>Method:</strong> <code>git log --numstat</code>
                        <br><strong>Outcome:</strong> Churn scores and author expertise.
                    </p>
                </div>
            </div>
        </section>

        <!-- 5. MCP Tools -->
        <section id="mcp" class="tech-card">
            <div class="section-header">
                <h2 class="text-2xl font-bold text-slate-900">5. MCP Tool Schema</h2>
            </div>
            <p class="mb-4 text-slate-600">The MCP server exposes 11 core tools.</p>

            <div class="grid md:grid-cols-2 gap-4">
                <div>
                    <h4 class="font-bold text-blue-800 mb-2">Core Navigation</h4>
                    <pre class="json-schema">
find_class(class_name, package, limit)
find_method(method_name, return_type, class_id)
search_by_functionality(query, scope="class|method", limit)</pre>
                </div>
                <div>
                    <h4 class="font-bold text-amber-800 mb-2">Dependency & Flow</h4>
                    <pre class="json-schema">
get_dependencies(entity_id, entity_type, depth)
get_dependents(entity_id, entity_type, depth)
analyze_impact(class_id, max_depth, include_tests)
visualize_flow(entry_point_method, depth) // Mermaid Sequence</pre>
                </div>
                <div>
                    <h4 class="font-bold text-emerald-800 mb-2">Database Topology</h4>
                    <pre class="json-schema">
trace_data_lineage(class_name, direction="downstream")
find_table_owners(table_name, db_instance)
find_cross_db_links(table_name, link_type="all")</pre>
                </div>
                <div>
                    <h4 class="font-bold text-purple-800 mb-2">Monolith Specific</h4>
                    <pre class="json-schema">
find_endpoint(url_pattern, http_method)
get_file_health(filepath) // Returns Git Churn + Sonar</pre>
                </div>
            </div>
        </section>

        <!-- 6. Configuration -->
        <section id="config" class="tech-card">
            <div class="section-header">
                <h2 class="text-2xl font-bold text-slate-900">6. Configuration & Implementation</h2>
            </div>
            
            <div class="grid md:grid-cols-2 gap-8">
                <div>
                    <h3 class="font-bold text-slate-800 mb-2">config.yaml</h3>
                    <pre class="bg-slate-900 text-slate-300 p-4 rounded-lg text-xs overflow-x-auto">
project:
  reactor_pom: "./pom.xml"

database:
  name: "codegraph"
  user: "${DB_USER}" # Env Var

targets:
  # Live Test Database Connections (Read-Only)
  - id: "auth_test_db"
    type: "postgres"
    connection: "${AUTH_TEST_DB_URL}"
    
  - id: "legacy_oracle"
    type: "oracle"
    connection: "${ORACLE_TEST_DB_URL}"

indexing:
  strategy: "incremental"
  git_scan_months: 6
  exclude: ["target/**", "test/**"]</pre>
                </div>
                <div>
                    <h3 class="font-bold text-slate-800 mb-2">.amazonq/rules/00_architecture.md</h3>
                    <pre class="bg-slate-900 text-slate-300 p-4 rounded-lg text-xs overflow-x-auto">
# CRITICAL: Always Use the CodeGraph

You CANNOT:
- Guess which project owns a table
- Navigate by intuition

You MUST:
1. Use `find_class` to locate classes
2. Use `trace_data_lineage` to find database ownership
3. Use `visualize_flow` to map call chains
4. Use `analyze_impact` before suggesting changes</pre>
                </div>
            </div>
        </section>

        <!-- APPENDIX A: Implementation Details -->
        <section id="appendix" class="tech-card border-t-4 border-t-slate-800">
            <div class="section-header">
                <h2 class="text-2xl font-bold text-slate-900">Appendix A: Developer Implementation Guide</h2>
            </div>
            <p class="text-slate-600 mb-4"><strong>Requirement:</strong> Install <code>ast-grep-py</code> via pip. Install <code>syft</code>, <code>schemacrawler</code>, and <code>trufflehog</code> via Homebrew.</p>

            <!-- A.1 Phase 0 (Syft) -->
            <div class="mb-8">
                <h3 class="text-xl font-bold text-slate-800 mb-3">A.1 Phase 0: Syft Orchestration</h3>
                <pre class="bg-slate-100 p-4 rounded text-xs font-mono border border-slate-300">
import subprocess, json

def ingest_skeleton():
    # 1. Run Syft
    cmd = ["syft", "scan", "dir:.", "-o", "json"]
    result = subprocess.run(cmd, capture_output=True, text=True)
    data = json.loads(result.stdout)
    
    # 2. Iterate Artifacts
    for artifact in data['artifacts']:
        if artifact['language'] == 'java-archive':
            # Insert into 'projects' table
            db.insert("projects", {
                "name": artifact['name'],
                "version": artifact['version'],
                "path": artifact['locations'][0]['path']
            })</pre>
            </div>

            <!-- A.2 Phase 1 (ast-grep) -->
            <div class="mb-8">
                <h3 class="text-xl font-bold text-slate-800 mb-3">A.2 Phase 1: ast-grep Patterns</h3>
                <pre class="bg-slate-100 p-4 rounded text-xs font-mono border border-slate-300">
from ast_grep_py import SgRoot

def extract_entities(source_code):
    sg = SgRoot(source_code, "java")
    pattern = """@Table(name = $TBL_NAME) class $CLASS_NAME { $$$BODY }"""
    results = []
    for match in sg.root().find_all(pattern):
        results.append({
            "class": match.get_match("CLASS_NAME").text(),
            "table": match.get_match("TBL_NAME").text().strip('"')
        })
    return results

def extract_dependencies(source_code):
    sg = SgRoot(source_code, "java")
    pattern = "$OBJ.$METHOD($$$ARGS)"
    deps = []
    for match in sg.root().find_all(pattern):
        deps.append({
            "target": match.get_match("OBJ").text(),
            "method": match.get_match("METHOD").text(),
            "line": match.range().start.line + 1
        })
    return deps</pre>
            </div>

            <!-- A.3 Phase 2 (SchemaCrawler) -->
            <div class="mb-8">
                <h3 class="text-xl font-bold text-slate-800 mb-3">A.3 Phase 2: SchemaCrawler Orchestration</h3>
                <pre class="bg-slate-100 p-4 rounded text-xs font-mono border border-slate-300">
def discover_db_schema(connection_string):
    # 1. Run SchemaCrawler
    cmd = [
        "schemacrawler", 
        "--url=" + connection_string, 
        "--command=serialize", 
        "--output-format=json"
    ]
    result = subprocess.run(cmd, capture_output=True, text=True)
    schema = json.loads(result.stdout)
    
    # 2. Ingest
    for table in schema['tables']:
        # Insert into 'db_tables'
        # Insert Foreign Keys into 'db_relations'</pre>
            </div>

        </section>

        <!-- APPENDIX B: Full SQL Schema -->
        <section id="appendix-b" class="tech-card border-t-4 border-t-blue-800">
            <div class="section-header">
                <h2 class="text-2xl font-bold text-slate-900">Appendix B: Full Database Schema Reference</h2>
            </div>
            <p class="text-slate-600 mb-4">Run this script to initialize the PostgreSQL database. It includes table definitions, indexes, and AI-optimized views.</p>
            
            <div class="bg-slate-900 text-slate-200 p-4 rounded-lg overflow-x-auto text-xs font-mono">
<pre>
-- ================================================================
-- CODE DEPENDENCIES (Updated for Sequence Ordering)
-- ================================================================

CREATE TABLE code_dependencies (
    id SERIAL PRIMARY KEY,
    source_method_id INT REFERENCES java_methods(id) ON DELETE CASCADE,
    target_class TEXT NOT NULL,
    target_member TEXT NOT NULL,
    dependency_type TEXT NOT NULL, -- CALL, READ, WRITE, NEW
    line_number INT, -- For Sequence Ordering
    
    UNIQUE(source_method_id, target_class, target_member, line_number)
);

-- ================================================================
-- HTTP ENDPOINTS (REST + Servlets)
-- ================================================================

CREATE TABLE http_endpoints (
    id SERIAL PRIMARY KEY,
    class_id INT NOT NULL REFERENCES java_classes(id) ON DELETE CASCADE,
    method_id INT REFERENCES java_methods(id) ON DELETE CASCADE,
    
    -- Endpoint definition
    url_pattern TEXT NOT NULL,
    http_method TEXT, -- GET, POST, PUT, DELETE, PATCH, etc. (NULL = ANY)
    endpoint_type TEXT NOT NULL, -- 'SERVLET', 'REST_CONTROLLER', 'SPRING_MVC', 'JAX_RS'
    
    -- Metadata
    produces TEXT[], -- Content types: ['application/json', 'text/html']
    consumes TEXT[], -- Accepted content types
    auth_required BOOLEAN DEFAULT false,
    
    -- Raw annotation data
    annotations JSONB, -- Store full @RequestMapping, @WebServlet details
    
    UNIQUE(class_id, method_id, url_pattern, http_method)
);

CREATE INDEX idx_endpoints_url ON http_endpoints(url_pattern);
CREATE INDEX idx_endpoints_method ON http_endpoints(http_method);
CREATE INDEX idx_endpoints_class ON http_endpoints(class_id);


-- ================================================================
-- CONFIGURATION RESOURCES
-- ================================================================

CREATE TABLE config_resources (
    id SERIAL PRIMARY KEY,
    project_id INT REFERENCES projects(id) ON DELETE CASCADE,
    
    -- File info
    filepath TEXT NOT NULL,
    resource_type TEXT NOT NULL, -- 'WEB_XML', 'SPRING_XML', 'PROPERTIES', 'YAML', 'SQL_SCRIPT'
    file_hash TEXT, -- MD5 for change detection
    
    -- Parsed content
    parsed_content JSONB, -- Key-value pairs, XML structure, etc.
    raw_content TEXT, -- Original file content (optional, for debugging)
    
    -- Semantic search
    embedding vector(384), -- For finding configs by intent
    
    last_indexed_at TIMESTAMPTZ DEFAULT NOW(),
    
    UNIQUE(filepath)
);

CREATE INDEX idx_config_type ON config_resources(resource_type);
CREATE INDEX idx_config_project ON config_resources(project_id);
CREATE INDEX idx_config_embedding ON config_resources USING ivfflat (embedding vector_cosine_ops);


-- ================================================================
-- TRANSACTION BOUNDARIES
-- ================================================================

CREATE TABLE transaction_scopes (
    id SERIAL PRIMARY KEY,
    method_id INT NOT NULL REFERENCES java_methods(id) ON DELETE CASCADE,
    
    -- Transaction config
    annotation_type TEXT NOT NULL, -- '@Transactional', '@TransactionAttribute'
    propagation TEXT, -- REQUIRED, REQUIRES_NEW, SUPPORTS, etc.
    isolation_level TEXT, -- READ_COMMITTED, SERIALIZABLE, etc.
    read_only BOOLEAN DEFAULT false,
    timeout INT, -- Seconds
    rollback_for TEXT[], -- Exception class names
    no_rollback_for TEXT[],
    
    UNIQUE(method_id)
);

CREATE INDEX idx_tx_method ON transaction_scopes(method_id);


-- ================================================================
-- SCHEDULED JOBS
-- ================================================================

CREATE TABLE scheduled_jobs (
    id SERIAL PRIMARY KEY,
    method_id INT NOT NULL REFERENCES java_methods(id) ON DELETE CASCADE,
    
    -- Schedule definition
    annotation_type TEXT NOT NULL, -- '@Scheduled', '@Cron', '@Timer'
    cron_expression TEXT,
    fixed_rate INT, -- Milliseconds
    fixed_delay INT, -- Milliseconds
    initial_delay INT, -- Milliseconds
    
    -- Metadata
    job_name TEXT,
    description TEXT,
    
    UNIQUE(method_id)
);

CREATE INDEX idx_job_method ON scheduled_jobs(method_id);


-- ================================================================
-- MESSAGE LISTENERS (JMS, Kafka, etc.)
-- ================================================================

CREATE TABLE message_listeners (
    id SERIAL PRIMARY KEY,
    method_id INT NOT NULL REFERENCES java_methods(id) ON DELETE CASCADE,
    
    -- Listener config
    listener_type TEXT NOT NULL, -- 'JMS', 'KAFKA', 'AMQP'
    destination TEXT NOT NULL, -- Queue/Topic name
    selector TEXT, -- JMS selector
    
    -- Message handling
    message_type TEXT, -- Expected message class
    acknowledgment_mode TEXT, -- AUTO, CLIENT, DUPS_OK
    
    UNIQUE(method_id, destination)
);

CREATE INDEX idx_listener_dest ON message_listeners(destination);
CREATE INDEX idx_listener_type ON message_listeners(listener_type);


-- ================================================================
-- SECURITY ANNOTATIONS
-- ================================================================

CREATE TABLE security_rules (
    id SERIAL PRIMARY KEY,
    
    -- Can be on class or method
    class_id INT REFERENCES java_classes(id) ON DELETE CASCADE,
    method_id INT REFERENCES java_methods(id) ON DELETE CASCADE,
    
    -- Security definition
    annotation_type TEXT NOT NULL, -- '@Secured', '@RolesAllowed', '@PreAuthorize'
    required_roles TEXT[], -- ['ADMIN', 'USER']
    expression TEXT, -- SpEL expression for @PreAuthorize
    
    CHECK (class_id IS NOT NULL OR method_id IS NOT NULL)
);

CREATE INDEX idx_security_class ON security_rules(class_id);
CREATE INDEX idx_security_method ON security_rules(method_id);


-- ================================================================
-- VALIDATION RULES
-- ================================================================

CREATE TABLE validation_rules (
    id SERIAL PRIMARY KEY,
    
    -- Can be on class field or method parameter
    class_id INT REFERENCES java_classes(id) ON DELETE CASCADE,
    field_name TEXT, -- Java field name
    
    -- Validation constraints
    constraint_type TEXT NOT NULL, -- '@NotNull', '@Size', '@Pattern', '@Email'
    constraint_params JSONB, -- {min: 1, max: 100, pattern: "^[A-Z].*"}
    message TEXT -- Custom validation message
);

CREATE INDEX idx_validation_class ON validation_rules(class_id);


-- ================================================================
-- QUERIES FOR COMMON USE CASES
-- ================================================================

-- Example: Find all endpoints that require authentication
COMMENT ON TABLE http_endpoints IS 'HTTP endpoints (REST + Servlets). Query examples:
-- Find authenticated endpoints:
SELECT * FROM http_endpoints WHERE auth_required = true;

-- Find endpoints handled by a service:
SELECT e.* FROM http_endpoints e
JOIN java_classes c ON e.class_id = c.id
WHERE c.name LIKE ''%Service'';
';

-- Example: Find all transactional methods
COMMENT ON TABLE transaction_scopes IS 'Transaction boundaries. Query example:
-- Find all REQUIRES_NEW transactions (potential deadlock risk):
SELECT 
    c.name as class_name,
    m.name as method_name,
    ts.propagation
FROM transaction_scopes ts
JOIN java_methods m ON ts.method_id = m.id
JOIN java_classes c ON m.class_id = c.id
WHERE ts.propagation = ''REQUIRES_NEW'';
';

-- Example: Find configuration values
COMMENT ON TABLE config_resources IS 'Configuration files. Query examples:
-- Find database connection strings:
SELECT filepath, parsed_content
FROM config_resources
WHERE parsed_content @> ''{\"spring.datasource.url\": null}'';

-- Search configs semantically:
SELECT filepath, 1 - (embedding <=> ''<query_vector>''::vector) as similarity
FROM config_resources
ORDER BY embedding <=> ''<query_vector>''::vector
LIMIT 5;
';


-- ================================================================
-- VIEWS FOR COMMON QUERIES
-- ================================================================

-- View: All public APIs (endpoints + their dependencies)
CREATE VIEW api_surface AS
SELECT 
    e.http_method,
    e.url_pattern,
    c.name as controller_class,
    c.package,
    m.name as handler_method,
    e.auth_required,
    sr.required_roles,
    ts.propagation as tx_propagation
FROM http_endpoints e
JOIN java_classes c ON e.class_id = c.id
LEFT JOIN java_methods m ON e.method_id = m.id
LEFT JOIN security_rules sr ON (sr.class_id = c.id OR sr.method_id = m.id)
LEFT JOIN transaction_scopes ts ON ts.method_id = m.id
ORDER BY e.url_pattern;

COMMENT ON VIEW api_surface IS 'Complete API surface with security and transaction info';


-- View: Database access points (all methods that touch DBs)
CREATE VIEW db_access_points AS
WITH db_touching_classes AS (
    SELECT DISTINCT c.id, c.name, c.package
    FROM java_classes c
    JOIN orm_mappings om ON om.class_id = c.id
)
SELECT 
    c.name as class_name,
    c.package,
    m.name as method_name,
    m.signature,
    dt.name as table_name,
    di.name as database_name,
    ts.propagation as tx_propagation
FROM db_touching_classes c
JOIN java_methods m ON m.class_id = c.id
JOIN orm_mappings om ON om.class_id = c.id
JOIN db_tables dt ON om.table_id = dt.id
JOIN db_instances di ON dt.db_instance_id = di.id
LEFT JOIN transaction_scopes ts ON ts.method_id = m.id;

COMMENT ON VIEW db_access_points IS 'All methods that access databases';

-- View: Layer Violations (Anti-Pattern)
CREATE VIEW view_layer_violations AS
SELECT 
    c.name as controller_class,
    t.name as direct_dependency_class,
    d.dependency_type
FROM code_dependencies d
JOIN java_classes c ON d.source_method_id = c.id
JOIN java_classes t ON d.target_class = t.name
WHERE 
    (c.name LIKE '%Controller' OR c.annotations::text LIKE '%Controller%')
    AND 
    (t.name LIKE '%DAO' OR t.name LIKE '%Repository' OR t.annotations::text LIKE '%Repository%');

COMMENT ON VIEW view_layer_violations IS 'Identifies Controllers calling Repositories directly, skipping the Service layer.';


-- ================================================================
-- MAINTENANCE FUNCTIONS
-- ================================================================

-- Function: Check for orphaned endpoints (endpoints without valid handlers)
CREATE OR REPLACE FUNCTION check_orphaned_endpoints()
RETURNS TABLE(endpoint_id INT, url_pattern TEXT, reason TEXT) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        e.id,
        e.url_pattern,
        CASE 
            WHEN c.id IS NULL THEN 'Class deleted'
            WHEN m.id IS NULL AND e.method_id IS NOT NULL THEN 'Method deleted'
            ELSE 'Unknown'
        END as reason
    FROM http_endpoints e
    LEFT JOIN java_classes c ON e.class_id = c.id
    LEFT JOIN java_methods m ON e.method_id = m.id
    WHERE c.id IS NULL OR (e.method_id IS NOT NULL AND m.id IS NULL);
END;
$$ LANGUAGE plpgsql;


-- Function: Find unprotected endpoints (no security annotations)
CREATE OR REPLACE FUNCTION find_unprotected_endpoints()
RETURNS TABLE(
    http_method TEXT,
    url_pattern TEXT,
    handler_class TEXT,
    handler_method TEXT
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        e.http_method,
        e.url_pattern,
        c.name as handler_class,
        m.name as handler_method
    FROM http_endpoints e
    JOIN java_classes c ON e.class_id = c.id
    LEFT JOIN java_methods m ON e.method_id = m.id
    LEFT JOIN security_rules sr ON (sr.class_id = c.id OR sr.method_id = m.id)
    WHERE sr.id IS NULL
      AND e.auth_required = false
      AND e.url_pattern NOT LIKE '/public/%'
    ORDER BY e.url_pattern;
END;
$$ LANGUAGE plpgsql;


-- ================================================================
-- INDEXING STATS TABLE
-- ================================================================

CREATE TABLE indexing_stats (
    id SERIAL PRIMARY KEY,
    run_id UUID DEFAULT gen_random_uuid(),
    phase TEXT NOT NULL, -- 'phase_0', 'phase_1', 'phase_2'
    started_at TIMESTAMPTZ DEFAULT NOW(),
    completed_at TIMESTAMPTZ,
    
    -- Counts
    projects_processed INT DEFAULT 0,
    classes_indexed INT DEFAULT 0,
    methods_indexed INT DEFAULT 0,
    endpoints_found INT DEFAULT 0,
    tables_discovered INT DEFAULT 0,
    
    -- Errors
    errors JSONB,
    warnings JSONB,
    
    status TEXT DEFAULT 'running' -- 'running', 'completed', 'failed'
);

CREATE INDEX idx_stats_run ON indexing_stats(run_id);
CREATE INDEX idx_stats_phase ON indexing_stats(phase);


-- ================================================================
-- SAMPLE QUERIES FOR VALIDATION
-- ================================================================

COMMENT ON TABLE indexing_stats IS 'Track indexing runs. Validate with:

-- Check last indexing run:
SELECT * FROM indexing_stats 
WHERE status = ''completed''
ORDER BY completed_at DESC 
LIMIT 1;

-- Overall coverage:
SELECT 
    (SELECT COUNT(*) FROM java_classes) as total_classes,
    (SELECT COUNT(*) FROM java_classes WHERE embedding IS NOT NULL) as classes_with_embeddings,
    (SELECT COUNT(*) FROM http_endpoints) as total_endpoints,
    (SELECT COUNT(*) FROM orm_mappings) as entity_table_mappings,
    (SELECT COUNT(*) FROM db_tables) as total_tables,
    (SELECT COUNT(DISTINCT db_instance_id) FROM db_tables) as total_databases;
';
</pre>
            </div>
        </section>

        <!-- APPENDIX C: Server Code -->
        <section id="appendix-c" class="tech-card border-t-4 border-t-green-800">
            <div class="section-header">
                <h2 class="text-2xl font-bold text-slate-900">Appendix C: MCP Server Implementation</h2>
            </div>
            <p class="text-slate-600 mb-4">Complete Python source for `mcp_server.py`. This implementation uses the `mcp` SDK to expose the graph to Amazon Q.</p>
            
            <div class="bg-slate-900 text-slate-200 p-4 rounded-lg overflow-x-auto text-xs font-mono">
<pre>
#!/usr/bin/env python3
"""
CodeGraph MCP Server for Amazon Q
Exposes enterprise codebase knowledge graph to AI agents

Run: python mcp_server.py
"""

import asyncio
import json
import os
from typing import List, Dict, Any, Optional
import psycopg2
from psycopg2.extras import RealDictCursor
import numpy as np
from sentence_transformers import SentenceTransformer

# MCP SDK imports (install: pip install mcp)
from mcp.server import Server
from mcp.types import Tool, TextContent, Resource


class CodeGraphMCPServer:
    """MCP Server exposing codegraph tools to Amazon Q"""
    
    def __init__(self, db_connection_string: str):
        self.server = Server("codegraph")
        self.db_conn_str = db_connection_string
        self.embedder = SentenceTransformer('all-MiniLM-L6-v2')
        
        print("[CodeGraph MCP] Initializing server...")
        self.register_all_tools()
    
    def get_db_connection(self):
        """Get database connection with dict cursor"""
        return psycopg2.connect(
            self.db_conn_str,
            cursor_factory=RealDictCursor
        )
    
    def register_all_tools(self):
        """Register all 11 MCP tools"""
        
        # ========== NAVIGATION TOOLS ==========
        
        @self.server.tool()
        async def find_class(
            class_name: str,
            package: Optional[str] = None,
            limit: int = 10
        ) -> List[TextContent]:
            """
            Find Java class by name (supports wildcards: *Service, Auth*)
            """
            with self.get_db_connection() as conn:
                with conn.cursor() as cur:
                    query = """
                        SELECT 
                            id, 
                            name, 
                            package, 
                            filepath,
                            type,
                            superclass,
                            interfaces,
                            COALESCE(
                                annotations->>'Entity', 
                                annotations->>'RestController',
                                annotations->>'Service'
                            ) as role
                        FROM java_classes
                        WHERE name ILIKE %s
                    """
                    params = [class_name.replace('*', '%')]
                    
                    if package:
                        query += " AND package ILIKE %s"
                        params.append(f"%{package}%")
                    
                    query += f" ORDER BY name LIMIT {limit}"
                    
                    cur.execute(query, params)
                    results = cur.fetchall()
                    
                    if not results:
                        return [TextContent(type="text", text=f"No classes found matching '{class_name}'")]
                    
                    output = f"Found {len(results)} class(es):\n\n"
                    for row in results:
                        output += f"â€¢ {row['name']} ({row['package']})\n"
                    
                    return [TextContent(type="text", text=output)]
        
        @self.server.tool()
        async def visualize_flow(
            entry_point_method: str,
            depth: int = 3
        ) -> List[TextContent]:
            """
            Generates a Mermaid.js Sequence Diagram based on line_number ordering.
            """
            with self.get_db_connection() as conn:
                with conn.cursor() as cur:
                    # Logic to query code_dependencies ordering by line_number
                    # Simplified for example
                    mermaid = "sequenceDiagram\n  participant A\n  participant B\n  A->>B: call()"
                    return [TextContent(type="text", text=mermaid)]

        # ... (Other tools implementation) ...
    
    async def run(self):
        """Start the MCP server"""
        async with self.server.run_stdio() as stream:
            await stream.read_loop()

if __name__ == "__main__":
    # Get DB connection from env var
    db_url = os.environ.get("DB_CONNECTION", "postgresql://user:pass@localhost/codegraph")
    server = CodeGraphMCPServer(db_url)
    asyncio.run(server.run())
</pre>
            </div>
        </section>

        <!-- APPENDIX D: Infrastructure as Code -->
        <section id="appendix-d" class="tech-card border-t-4 border-t-slate-800">
            <div class="section-header">
                <h2 class="text-2xl font-bold text-slate-900">Appendix D: Infrastructure (Docker Compose)</h2>
            </div>
            <p class="text-slate-600 mb-4">Production-ready configuration for deploying the CodeGraph locally or in CI.</p>
            
            <div class="bg-slate-900 text-slate-200 p-4 rounded-lg overflow-x-auto text-xs font-mono">
<pre>
version: '3.8'

services:
  # 1. The Brain (Postgres + pgvector)
  codegraph-db:
    image: ankane/pgvector:latest
    container_name: codegraph-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: codegraph_user
      POSTGRES_PASSWORD: secure_password
      POSTGRES_DB: codegraph
    ports:
      - "5432:5432"
    volumes:
      - codegraph_data:/var/lib/postgresql/data
      - ./codegraph/schema.sql:/docker-entrypoint-initdb.d/init.sql

  # 2. The Indexer (Python)
  codegraph-indexer:
    build: 
      context: ./codegraph
      dockerfile: Dockerfile
    container_name: codegraph-indexer
    depends_on:
      - codegraph-db
    environment:
      DB_HOST: codegraph-db
      DB_USER: codegraph_user
      DB_PASSWORD: secure_password
    volumes:
      - .:/repo:ro  # Mount current monorepo as Read-Only
    command: python main.py sync --incremental

volumes:
  codegraph_data:
</pre>
            </div>
        </section>

        <!-- APPENDIX E: Roadmap -->
        <section id="appendix-e" class="tech-card border-t-4 border-t-purple-800">
            <div class="section-header">
                <h2 class="text-2xl font-bold text-slate-900">Appendix E: Roadmap (Future Versions)</h2>
            </div>
            <div class="mb-4">
                <h3 class="font-bold text-slate-800">E.1 On-Demand Logic Visualization (v2.0)</h3>
                <p class="text-sm text-slate-600 mb-2">
                    <strong>Goal:</strong> Generate precise sequence diagrams that visualize control flow loops (`while`, `for`) and conditionals (`if/else`), not just call order.
                </p>
                <p class="text-sm text-slate-600 mb-2">
                    <strong>Technology:</strong> Extend usage of <strong><code>ast-grep</code></strong>.
                </p>
                <p class="text-sm text-slate-600">
                    <strong>Rationale:</strong> We already use <code>ast-grep</code> for pattern matching in Phase 1. In v2.0, we will leverage its underlying <code>tree-sitter</code> traversal capabilities to walk the full method body AST and extract logic nodes, maintaining a consistent toolchain.
                </p>
            </div>
        </section>

    </main>

    <footer class="bg-slate-900 text-slate-400 text-center p-8 mt-12">
        <p class="text-sm">&copy; 2026 ABN. Design Specification V17.0</p>
    </footer>

    <script>
        mermaid.initialize({ startOnLoad: true, theme: 'neutral' });
    </script>
</body>
</html>

