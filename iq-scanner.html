
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>BioScanner IQ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { 
            --sat: env(safe-area-inset-top); 
            --sab: env(safe-area-inset-bottom); 
        }
        body { 
            background: #000; 
            margin: 0; 
            padding: 0; 
            color: #fff; 
            font-family: ui-sans-serif, system-ui, sans-serif; 
            height: 100dvh; 
            width: 100vw; 
            overflow: hidden; 
        }
        #root { height: 100%; width: 100%; }
        @keyframes scanline { 
            0% { top: 0%; opacity: 0; } 
            10% { opacity: 1; } 
            90% { opacity: 1; } 
            100% { top: 100%; opacity: 0; } 
        }
        .scanner-line {
            position: absolute; 
            width: 100%; 
            height: 3px;
            background: #6366f1; 
            box-shadow: 0 0 20px #6366f1;
            animation: scanline 2.5s ease-in-out infinite;
            z-index: 10;
        }
        .no-tap { -webkit-tap-highlight-color: transparent; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #4338ca; border-radius: 10px; }
    </style>
</head>
<body class="no-tap">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const STORAGE_KEY = 'IQ_SCANNER_PROFILES_V6';
        const SIMILARITY_THRESHOLD = 0.45;
        const RANDOM_IQ_MIN = 80;
        const RANDOM_IQ_MAX = 100;

        const App = () => {
            const [view, setView] = useState('home'); 
            const [modelsLoaded, setModelsLoaded] = useState(false);
            const [profiles, setProfiles] = useState([]);
            const [scanning, setScanning] = useState(false);
            const [result, setResult] = useState(null);
            const [statusMessage, setStatusMessage] = useState(null);
            
            const videoRef = useRef(null);
            const streamRef = useRef(null);

            useEffect(() => {
                const load = async () => {
                    const URL = 'https://justadudewhohacks.github.io/face-api.js/models';
                    try {
                        await Promise.all([
                            faceapi.nets.tinyFaceDetector.loadFromUri(URL),
                            faceapi.nets.faceLandmark68Net.loadFromUri(URL),
                            faceapi.nets.faceRecognitionNet.loadFromUri(URL)
                        ]);
                        setModelsLoaded(true);
                    } catch (e) { 
                        console.error("AI Model Load Failed:", e); 
                    }
                };
                load();
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) setProfiles(JSON.parse(saved));
            }, []);

            const showMessage = (msg) => {
                setStatusMessage(msg);
                setTimeout(() => setStatusMessage(null), 3000);
            };

            const startCam = async () => {
                if (streamRef.current) stopCam();
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: { 
                            facingMode: 'user', 
                            width: { ideal: 1280 }, 
                            height: { ideal: 720 } 
                        }
                    });
                    streamRef.current = stream;
                    if (videoRef.current) {
                        videoRef.current.srcObject = stream;
                    }
                } catch (e) { 
                    console.error("Camera access failed:", e);
                }
            };

            const stopCam = () => {
                if (streamRef.current) {
                    streamRef.current.getTracks().forEach(t => t.stop());
                    streamRef.current = null;
                }
                if (videoRef.current) {
                    videoRef.current.srcObject = null;
                }
            };

            const calculateDistance = (v1, v2) => {
                return Math.sqrt(v1.reduce((acc, val, i) => acc + Math.pow(val - v2[i], 2), 0));
            };

            const handleScan = async () => {
                if (!streamRef.current) await startCam();
                
                setScanning(true);
                setResult(null);
                
                setTimeout(async () => {
                    if (!videoRef.current) {
                        setScanning(false);
                        return;
                    }

                    const detect = await faceapi.detectSingleFace(
                        videoRef.current, 
                        new faceapi.TinyFaceDetectorOptions()
                    ).withFaceLandmarks().withFaceDescriptor();
                    
                    if (!detect) {
                        setResult({ error: "Biometric capture failed. Align face in viewfinder." });
                        setScanning(false);
                        return;
                    }

                    const desc = Array.from(detect.descriptor);
                    let match = profiles.find(p => calculateDistance(desc, p.descriptor) < SIMILARITY_THRESHOLD);

                    let finalIq;
                    if (match) {
                        finalIq = match.iq;
                    } else {
                        finalIq = Math.floor(Math.random() * (RANDOM_IQ_MAX - RANDOM_IQ_MIN + 1)) + RANDOM_IQ_MIN;
                        const newProfile = {
                            id: Date.now(),
                            iq: finalIq,
                            descriptor: desc,
                            date: new Date().toLocaleDateString(),
                            type: 'Auto'
                        };
                        const updated = [...profiles, newProfile];
                        setProfiles(updated);
                        localStorage.setItem(STORAGE_KEY, JSON.stringify(updated));
                    }

                    setResult({ iq: finalIq });
                    setScanning(false);
                }, 2500);
            };

            const registerManualProfile = async () => {
                const iqInput = document.getElementById('iq-val');
                const val = parseInt(iqInput.value);
                if (isNaN(val)) return;

                const detect = await faceapi.detectSingleFace(videoRef.current, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
                if (!detect) {
                    showMessage("No face detected.");
                    return;
                }
                
                const desc = Array.from(detect.descriptor);
                const filteredProfiles = profiles.filter(p => calculateDistance(desc, p.descriptor) >= SIMILARITY_THRESHOLD);

                const newProfile = { 
                    id: Date.now(), 
                    iq: val, 
                    descriptor: desc,
                    date: new Date().toLocaleDateString(),
                    type: 'Manual'
                };
                
                const updated = [...filteredProfiles, newProfile];
                setProfiles(updated);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(updated));
                
                stopCam();
                setView('admin-list');
                showMessage(`Profile saved: IQ ${val}`);
            };

            const deleteProfile = (id) => {
                const updated = profiles.filter(p => p.id !== id);
                setProfiles(updated);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(updated));
            };

            return (
                <div className="flex flex-col h-full w-full bg-slate-950 select-none overflow-hidden">
                    {/* Status Notification Overlay */}
                    {statusMessage && (
                        <div className="fixed top-20 left-1/2 -translate-x-1/2 bg-indigo-600 text-white px-6 py-2 rounded-full font-bold text-xs z-[100] shadow-xl animate-bounce">
                            {statusMessage}
                        </div>
                    )}

                    <header className="px-5 py-4 pt-[calc(var(--sat)+0.5rem)] border-b border-white/5 flex justify-between items-center bg-black/60 backdrop-blur-md z-30 shrink-0">
                        <span 
                            className="font-black text-indigo-500 tracking-tighter text-sm uppercase italic cursor-pointer"
                            onClick={() => { stopCam(); setView('home'); setResult(null); }}
                        >
                            BioScanner <span className="text-white not-italic opacity-40">PRO</span>
                        </span>
                        <button 
                            onClick={() => { 
                                stopCam();
                                setResult(null);
                                setScanning(false);
                                setView(view.startsWith('admin') ? 'home' : 'admin-list');
                            }} 
                            className="p-2 opacity-10 active:opacity-100"
                        >
                            <i className="fa-solid fa-sliders text-lg"></i>
                        </button>
                    </header>

                    <main className="flex-1 relative bg-black overflow-hidden flex flex-col min-h-0">
                        {view === 'home' && (
                            <div className="absolute inset-0 flex flex-col items-center justify-center p-12 text-center z-20 bg-slate-950">
                                <div className="w-20 h-20 bg-indigo-600/10 rounded-full flex items-center justify-center mb-8 border border-indigo-600/20">
                                    <i className="fa-solid fa-dna text-3xl text-indigo-500"></i>
                                </div>
                                <h1 className="text-2xl font-black mb-3 uppercase tracking-widest">System Ready</h1>
                                <p className="text-slate-500 text-sm mb-12 leading-relaxed">Persistent biometric database active. Awaiting target acquisition.</p>
                                <button 
                                    onClick={() => { setView('scan'); startCam(); }} 
                                    disabled={!modelsLoaded} 
                                    className="w-full max-w-sm py-5 bg-indigo-600 rounded-2xl font-black text-sm tracking-[0.2em] active:scale-95 transition-transform disabled:opacity-20 shadow-lg"
                                >
                                    {modelsLoaded ? 'INITIALIZE SCAN' : 'CALIBRATING...'}
                                </button>
                            </div>
                        )}

                        {(view === 'scan' || view === 'admin-cam') && (
                            <video 
                                ref={videoRef} 
                                autoPlay 
                                muted 
                                playsInline 
                                className="absolute inset-0 w-full h-full object-cover"
                            />
                        )}

                        {view === 'scan' && (
                            <div className="absolute inset-0 pointer-events-none flex items-center justify-center p-10">
                                <div className="w-full aspect-[3/4] border border-indigo-500/30 rounded-[3rem] relative overflow-hidden bg-indigo-600/5">
                                    {scanning && <div className="scanner-line"></div>}
                                </div>
                            </div>
                        )}

                        {view === 'admin-list' && (
                            <div className="flex-1 flex flex-col p-6 bg-slate-950 overflow-hidden">
                                <div className="flex justify-between items-center mb-8 shrink-0">
                                    <h2 className="text-xl font-black uppercase tracking-tight">Biometric Registry</h2>
                                    <button 
                                        onClick={() => { setView('admin-cam'); startCam(); }}
                                        className="bg-indigo-600 px-5 py-3 rounded-xl text-xs font-bold active:scale-95"
                                    >
                                        <i className="fa-solid fa-user-plus"></i> New
                                    </button>
                                </div>
                                
                                <div className="flex-1 overflow-y-auto custom-scrollbar space-y-4 pr-1">
                                    {profiles.length === 0 ? (
                                        <div className="h-full flex flex-col items-center justify-center text-slate-600 text-sm text-center border-2 border-dashed border-white/5 rounded-3xl p-10">
                                            No biometric signatures cached.
                                        </div>
                                    ) : (
                                        profiles.map(p => (
                                            <div key={p.id} className="bg-white/5 border border-white/5 p-5 rounded-2xl flex justify-between items-center">
                                                <div>
                                                    <div className="flex items-center gap-2 mb-1">
                                                        <div className={`w-1.5 h-1.5 rounded-full ${p.type === 'Manual' ? 'bg-indigo-400' : 'bg-slate-500'}`}></div>
                                                        <div className="text-[10px] text-slate-400 font-bold tracking-[0.2em] uppercase">{p.type === 'Manual' ? 'Calibrated' : 'Auto-Cached'}</div>
                                                    </div>
                                                    <div className="text-2xl font-black tracking-tight">IQ: {p.iq}</div>
                                                    <div className="text-[9px] text-slate-600 font-mono mt-1 uppercase">Date: {p.date}</div>
                                                </div>
                                                <button 
                                                    onClick={() => deleteProfile(p.id)}
                                                    className="w-10 h-10 flex items-center justify-center bg-red-500/10 text-red-500/60 rounded-xl active:scale-90"
                                                >
                                                    <i className="fa-solid fa-trash-can"></i>
                                                </button>
                                            </div>
                                        ))
                                    )}
                                </div>

                                <button 
                                    onClick={() => { stopCam(); setView('home'); }}
                                    className="mt-8 w-full py-5 bg-slate-900 border border-white/10 rounded-2xl text-xs font-black uppercase tracking-[0.2em] text-slate-400 shrink-0"
                                >
                                    Return to Terminal
                                </button>
                            </div>
                        )}

                        {view === 'admin-cam' && (
                            <div className="absolute inset-0 flex flex-col">
                                <div className="flex-1 flex items-center justify-center p-12 pointer-events-none">
                                    <div className="w-full aspect-square border-2 border-dashed border-indigo-500/30 rounded-full"></div>
                                </div>
                                <div className="bg-black/95 border-t border-white/10 p-8 pb-[calc(var(--sab)+2rem)] shrink-0">
                                    <div className="flex gap-4 mb-6">
                                        <div className="flex-1">
                                            <label className="text-[10px] uppercase font-black text-indigo-400 ml-1 mb-2 block tracking-widest">Manual Override IQ</label>
                                            <input id="iq-val" type="number" defaultValue="131" className="w-full bg-slate-900 p-5 rounded-2xl border border-white/10 text-2xl font-black outline-none focus:border-indigo-500" />
                                        </div>
                                        <div className="flex flex-col justify-end">
                                            <button onClick={registerManualProfile} className="bg-indigo-600 px-8 py-5 rounded-2xl font-black active:scale-95">LOCK</button>
                                        </div>
                                    </div>
                                    <button onClick={() => { stopCam(); setView('admin-list'); }} className="w-full py-3 text-[10px] text-slate-600 uppercase tracking-[0.3em] font-black">Cancel</button>
                                </div>
                            </div>
                        )}

                        {result && (
                            <div className="absolute inset-0 bg-slate-950 flex flex-col items-center justify-center p-12 text-center z-50 overflow-hidden">
                                {result.error ? (
                                    <div className="text-red-400 font-bold p-8 bg-red-400/10 rounded-3xl border border-red-400/20 max-w-sm">{result.error}</div>
                                ) : (
                                    <>
                                        <div className="text-indigo-500 text-[10px] font-black tracking-[0.6em] uppercase mb-4">Biometric Result</div>
                                        <div className="text-[clamp(6rem,20vh,11rem)] font-black leading-none mb-4 tabular-nums text-white drop-shadow-[0_0_50px_rgba(99,102,241,0.5)]">
                                            {result.iq}
                                        </div>
                                        <div className="text-slate-500 text-[10px] font-bold tracking-[0.4em] uppercase mb-12">Identity Profile Verified</div>
                                    </>
                                )}
                                <button 
                                    onClick={() => { setResult(null); startCam(); }} 
                                    className="w-full max-w-sm py-5 bg-indigo-600 rounded-2xl font-black tracking-[0.3em] active:scale-95 shrink-0"
                                >
                                    RE-SCAN
                                </button>
                            </div>
                        )}
                    </main>

                    {view === 'scan' && !scanning && !result && (
                        <footer className="p-6 bg-slate-950 border-t border-white/5 flex gap-4 pb-[calc(var(--sab)+1.5rem)] z-30 shrink-0">
                            <button onClick={() => { stopCam(); setView('home'); }} className="flex-1 py-5 bg-slate-900 rounded-2xl text-[10px] font-black tracking-widest border border-white/10 uppercase">Abort</button>
                            <button onClick={handleScan} className="flex-[3] py-5 bg-indigo-600 rounded-2xl font-black text-sm tracking-[0.2em] uppercase shadow-lg shadow-indigo-600/20">Scan Identity</button>
                        </footer>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>